
> bearing-app@1.0.0 test
> jest

FAIL tests/api/upload.test.ts
  ΓùÅ POST /api/manuscripts/upload ΓÇ║ should handle PDF file upload

    expect(received).toBe(expected) // Object.is equality

    Expected: "PDF Content"
    Received: "PDF import temporarily disabled due to build issues."

      108 |     expect(res.status).toBe(200);
      109 |     const data = await res.json();
    > 110 |     expect(data.chapters[0].content).toBe("PDF Content");
          |                                      ^
      111 |   });
      112 |
      113 |   it("should handle Markdown file upload", async () => {

      at Object.toBe (tests/api/upload.test.ts:110:38)

FAIL tests/manuscripts/consistency.test.ts
  ΓùÅ Console

    console.error
      Error calling OpenRouter API: ZodError: [
        {
          "code": "invalid_value",
          "values": [
            "character",
            "plot",
            "timeline",
            "tone"
          ],
          "path": [
            "issues",
            0,
            "type"
          ],
          "message": "Invalid option: expected one of \"character\"|\"plot\"|\"timeline\"|\"tone\""
        },
        {
          "code": "invalid_value",
          "values": [
            "low",
            "medium",
            "high"
          ],
          "path": [
            "issues",
            0,
            "severity"
          ],
          "message": "Invalid option: expected one of \"low\"|\"medium\"|\"high\""
        }
      ]
          at parse (R:\Dropbox\_Code\Projects\bearing\bearing-app\src\lib\gemini.ts:337:44)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\manuscripts\consistency.test.ts:165:7)

      344 |       throw new Error(detailedError);
      345 |     }
    > 346 |     console.error("Error calling OpenRouter API:", error);
          |             ^
      347 |     throw error;
      348 |   }
      349 | }

      at error (src/lib/gemini.ts:346:13)
      at Object.<anonymous> (tests/manuscripts/consistency.test.ts:165:7)

    console.log
      Mock JSON called. Mock Report: {"issues":[],"summary":"No issues."}

      at Object.log (tests/manuscripts/consistency.test.ts:214:19)

  ΓùÅ Consistency Checks ΓÇ║ initiateConsistencyCheck ΓÇ║ should start a check and return job ID

    supabaseUrl is required.

      541 |   const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
      542 |   const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;
    > 543 |   const backgroundClient = createClient(supabaseUrl, supabaseServiceKey);
          |                                        ^
      544 |
      545 |   const backgroundTask = async () => {
      546 |     try {

      at validateSupabaseUrl (node_modules/@supabase/supabase-js/src/lib/helpers.ts:86:11)
      at new SupabaseClient (node_modules/@supabase/supabase-js/src/SupabaseClient.ts:117:21)
      at createClient (node_modules/@supabase/supabase-js/src/index.ts:60:10)
      at initiateConsistencyCheck (src/lib/gemini.ts:543:40)
      at Object.<anonymous> (tests/manuscripts/consistency.test.ts:191:22)

PASS tests/manuscripts/manuscript.test.ts
FAIL tests/api/consistency-check.test.ts
  ΓùÅ Console

    console.error
      Error initiating consistency check: Error: Token cap exceeded. You have 0 remaining this month.
          at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\api\consistency-check.test.ts:196:7)
          at Promise.finally.completed (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
          at _callCircusTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
          at R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
          at run (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
          at jestAdapter (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\runner.js:101:19)
          at runTestInternal (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\testWorker.js:275:16)
          at runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\testWorker.js:343:7)
          at Object.worker (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\testWorker.js:497:12)

      89 |     }, { status: 202 });
      90 |   } catch (error) {
    > 91 |     console.error("Error initiating consistency check:", error);
         |             ^
      92 |     
      93 |     // Handle token cap errors specifically
      94 |     if (error instanceof Error && error.message.includes("Token cap")) {

      at error (src/app/api/manuscripts/[id]/consistency-check/route.ts:91:13)
      at Object.<anonymous> (tests/api/consistency-check.test.ts:203:22)

    console.error
      Error initiating consistency check: Error: Manuscript content is empty
          at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\api\consistency-check.test.ts:212:7)
          at Promise.finally.completed (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
          at _callCircusTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
          at R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
          at run (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
          at jestAdapter (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\runner.js:101:19)
          at runTestInternal (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\testWorker.js:275:16)
          at runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\testWorker.js:343:7)
          at Object.worker (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\testWorker.js:497:12)

      89 |     }, { status: 202 });
      90 |   } catch (error) {
    > 91 |     console.error("Error initiating consistency check:", error);
         |             ^
      92 |     
      93 |     // Handle token cap errors specifically
      94 |     if (error instanceof Error && error.message.includes("Token cap")) {

      at error (src/app/api/manuscripts/[id]/consistency-check/route.ts:91:13)
      at Object.<anonymous> (tests/api/consistency-check.test.ts:219:22)

    console.error
      Error initiating consistency check: Error: Network error
          at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\api\consistency-check.test.ts:515:7)
          at Promise.finally.completed (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
          at _callCircusTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
          at R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
          at run (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
          at jestAdapter (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\runner.js:101:19)
          at runTestInternal (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\testWorker.js:275:16)
          at runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\testWorker.js:343:7)
          at Object.worker (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\testWorker.js:497:12)

      89 |     }, { status: 202 });
      90 |   } catch (error) {
    > 91 |     console.error("Error initiating consistency check:", error);
         |             ^
      92 |     
      93 |     // Handle token cap errors specifically
      94 |     if (error instanceof Error && error.message.includes("Token cap")) {

      at error (src/app/api/manuscripts/[id]/consistency-check/route.ts:91:13)
      at Object.<anonymous> (tests/api/consistency-check.test.ts:530:23)

  ΓùÅ POST /api/manuscripts/:id/consistency-check ΓÇ║ should create async job immediately and return job ID (AC 3.1.1)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      {"auth": {"getUser": [Function mockConstructor]}, "from": [Function mockConstructor]},
      Object {
        "manuscriptId": "ms-id",
    -   "userId": "user-id",
    +   "userId": "ms-id",
      },
    + [Function anonymous],

    Number of calls: 1

      135 |     expect(data.status).toBe("queued");
      136 |     expect(data.estimatedTokens).toBe(50000);
    > 137 |     expect(initiateConsistencyCheck).toHaveBeenCalledWith(
          |                                      ^
      138 |       mockSupabaseClient,
      139 |       {
      140 |         manuscriptId: "ms-id",

      at Object.toHaveBeenCalledWith (tests/api/consistency-check.test.ts:137:38)

  ΓùÅ POST /api/manuscripts/:id/consistency-check ΓÇ║ should return cached result immediately if available

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      160 |
      161 |     expect(response.status).toBe(202);
    > 162 |     expect(data.cached).toBe(true);
          |                         ^
      163 |     expect(data.status).toBe("completed");
      164 |   });
      165 |

      at Object.toBe (tests/api/consistency-check.test.ts:162:25)

PASS tests/admin/UserUsageTable.test.tsx
PASS tests/SignupForm.test.tsx
  ΓùÅ Console

    console.log
      {"level":"audit","type":"signup","email":"test@example.com","timestamp":"2026-01-08T00:24:57.162Z"}

      at log (src/lib/audit.ts:54:11)

    console.log
      {"level":"audit","type":"signup_failure","email":"invalid@example.com","metadata":{"reason":"Invalid email"},"timestamp":"2026-01-08T00:24:57.203Z"}

      at log (src/lib/audit.ts:54:11)

PASS tests/lib/useGhostText.test.ts
PASS tests/components/manuscripts/Binder.test.tsx
  ΓùÅ Console

    console.log
      <body>
        <div>
          <aside
            class="w-64 bg-slate-50/90 backdrop-blur-md border-r border-slate-200/50 overflow-y-auto flex-shrink-0 transition-all duration-300 ease-in-out "
          >
            <div
              class="p-4 border-b border-slate-200/50 bg-white/50 backdrop-blur-sm sticky top-0 z-10"
            >
              <h2
                class="text-xs font-bold text-slate-500 uppercase tracking-widest font-mono"
              >
                Binder
              </h2>
            </div>
            <ul
              class="py-2 space-y-0.5"
            >
              <li>
                <button
                  class="w-full text-left px-4 py-3 hover:bg-slate-100/50 flex items-center justify-between group transition-colors"
                >
                  <span
                    class="text-sm font-medium text-slate-700 group-hover:text-slate-900 line-clamp-2"
                  >
                    Chapter One
                  </span>
                </button>
              </li>
              <li>
                <button
                  class="w-full text-left px-4 py-3 hover:bg-slate-100/50 flex items-center justify-between group transition-colors"
                >
                  <span
                    class="text-sm font-medium text-slate-700 group-hover:text-slate-900 line-clamp-2"
                  >
                    Scene 1
                  </span>
                </button>
              </li>
              <li>
                <button
                  class="w-full text-left px-4 py-3 hover:bg-slate-100/50 flex items-center justify-between group transition-colors"
                >
                  <span
                    class="text-sm font-medium text-slate-700 group-hover:text-slate-900 line-clamp-2"
                  >
                    Chapter Two
                  </span>
                </button>
              </li>
            </ul>
          </aside>
        </div>
      </body>

      at debug (node_modules/@testing-library/react/dist/pure.js:203:13)

FAIL tests/integration/usage-guardrails.test.ts
  ΓùÅ Console

    console.log
      [dotenv@17.2.3] injecting env (7) from .env.local -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (node_modules/dotenv/lib/main.js:142:11)

    console.error
      Account creation RPC error: {
        code: 'P0001',
        details: null,
        hint: null,
        message: 'Permission denied: Owner ID does not match authenticated user'
      }

      43 |
      44 |     if (rpcError) {
    > 45 |       console.error("Account creation RPC error:", rpcError);
         |               ^
      46 |       return {
      47 |         account: null,
      48 |         error: "Failed to create account. Please try again.",

      at error (src/lib/account.ts:45:15)
      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:68:32)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should start in good_standing

    Failed to create test account

      67 |     // 2. Create Test Account
      68 |     const { account, error } = await createAccount(adminSupabase, "Guardrails Test Account", testUserId);
    > 69 |     if (error || !account) throw new Error("Failed to create test account");
         |                                  ^
      70 |     testAccountId = account.id;
      71 |   });
      72 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:69:34)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should flag account after first month of overage

    Failed to create test account

      67 |     // 2. Create Test Account
      68 |     const { account, error } = await createAccount(adminSupabase, "Guardrails Test Account", testUserId);
    > 69 |     if (error || !account) throw new Error("Failed to create test account");
         |                                  ^
      70 |     testAccountId = account.id;
      71 |   });
      72 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:69:34)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should trigger upsell_required after second consecutive month of overage

    Failed to create test account

      67 |     // 2. Create Test Account
      68 |     const { account, error } = await createAccount(adminSupabase, "Guardrails Test Account", testUserId);
    > 69 |     if (error || !account) throw new Error("Failed to create test account");
         |                                  ^
      70 |     testAccountId = account.id;
      71 |   });
      72 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:69:34)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should block usage when status is upsell_required

    Failed to create test account

      67 |     // 2. Create Test Account
      68 |     const { account, error } = await createAccount(adminSupabase, "Guardrails Test Account", testUserId);
    > 69 |     if (error || !account) throw new Error("Failed to create test account");
         |                                  ^
      70 |     testAccountId = account.id;
      71 |   });
      72 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:69:34)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should reset to good_standing if usage drops in third month

    Failed to create test account

      67 |     // 2. Create Test Account
      68 |     const { account, error } = await createAccount(adminSupabase, "Guardrails Test Account", testUserId);
    > 69 |     if (error || !account) throw new Error("Failed to create test account");
         |                                  ^
      70 |     testAccountId = account.id;
      71 |   });
      72 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:69:34)

PASS tests/lib/ai-usage.test.ts
PASS tests/api/manuscripts-suggest.test.ts
PASS tests/admin/admin.test.ts
PASS tests/rls/consistency-check.test.ts
PASS tests/sanity.test.ts
PASS tests/lib/email.test.ts
  ΓùÅ Console

    console.log
      [MOCK EMAIL] To: test@example.com, Subject: Test, Body: Hello

      at log (src/lib/email.ts:22:13)

PASS tests/manuscripts/versionHistory.test.ts
  ΓùÅ Console

    console.log
      [Test Setup] Initializing global stores

      at Object.log (tests/manuscripts/versionHistory.test.ts:53:13)

    console.log
      [Test Setup] Initializing global stores

      at Object.log (tests/manuscripts/versionHistory.test.ts:53:13)

    console.log
      [Test Setup] Initializing global stores

      at Object.log (tests/manuscripts/versionHistory.test.ts:53:13)

    console.log
      [Test Setup] Initializing global stores

      at Object.log (tests/manuscripts/versionHistory.test.ts:53:13)

    console.log
      [Test Setup] Initializing global stores

      at Object.log (tests/manuscripts/versionHistory.test.ts:53:13)

    console.log
      [Test Setup] Initializing global stores

      at Object.log (tests/manuscripts/versionHistory.test.ts:53:13)

    console.log
      [Test Setup] Initializing global stores

      at Object.log (tests/manuscripts/versionHistory.test.ts:53:13)

    console.error
      Unexpected error fetching version history: TypeError: supabase.from(...).select(...).eq(...).is(...).single is not a function
          at single (R:\Dropbox\_Code\Projects\bearing\bearing-app\src\lib\manuscriptVersions.ts:129:8)
          at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\manuscripts\versionHistory.test.ts:659:45)
          at Promise.finally.completed (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
          at _callCircusTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
          at _runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
          at R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
          at run (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
          at jestAdapter (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\runner.js:101:19)
          at runTestInternal (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\testWorker.js:275:16)
          at runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\testWorker.js:343:7)
          at Object.worker (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\testWorker.js:497:12)

      167 |     };
      168 |   } catch (err) {
    > 169 |     console.error("Unexpected error fetching version history:", err);
          |             ^
      170 |     return { versions: [], error: "Failed to fetch version history", hasMore: false, nextCursor: null };
      171 |   }
      172 | }

      at error (src/lib/manuscriptVersions.ts:169:13)
      at Object.<anonymous> (tests/manuscripts/versionHistory.test.ts:659:45)

    console.log
      [Test Setup] Initializing global stores

      at Object.log (tests/manuscripts/versionHistory.test.ts:53:13)

    console.log
      [Test Setup] Initializing global stores

      at Object.log (tests/manuscripts/versionHistory.test.ts:53:13)

PASS tests/api/tickets.test.ts
  ΓùÅ Console

    console.log
      [MOCK EMAIL] To: admin@example.com, Subject: [Support] New Ticket: Issue, Body: User user@test.com created a new ticket.
      
      Subject: Issue
      
      View Ticket: http://localhost:3000/dashboard/admin/support/ticket-1

      at log (src/lib/email.ts:22:13)

    console.error
      Account service error: TypeError: Cannot read properties of undefined (reading 'eq')
          at Object.getUserAccounts (R:\Dropbox\_Code\Projects\bearing\bearing-app\src\lib\account.ts:95:8)
          at getUserAccounts (R:\Dropbox\_Code\Projects\bearing\bearing-app\src\app\api\support\tickets\route.ts:70:43)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

      116 |     return { accounts, error: null };
      117 |   } catch (err) {
    > 118 |     console.error("Account service error:", err);
          |             ^
      119 |     return {
      120 |       accounts: [],
      121 |       error: "An unexpected error occurred. Please try again.",

      at Object.error (src/lib/account.ts:118:13)
      at getUserAccounts (src/app/api/support/tickets/route.ts:70:43)

PASS tests/lib/useZenMode.test.ts
PASS tests/rls/profile.test.ts
  ΓùÅ Console

    console.log
      [getOrCreateProfile] Starting lookup for authId: auth-user-123

      at log (src/lib/profile.ts:45:13)

    console.log
      [getOrCreateProfile] Profile fetch result: {
        found: false,
        claimed: false,
        profileId: undefined,
        fetchError: 'No rows found',
        errorCode: 'PGRST116'
      }

      at log (src/lib/profile.ts:65:13)

    console.log
      [getOrCreateProfile] No existing profile, creating new profile and account...

      at log (src/lib/profile.ts:153:13)

    console.log
      [createProfileWithAccount] Step 1: Creating user profile for: { authId: 'auth-user-123', email: 'newuser@example.com' }

      at log (src/lib/profile.ts:243:11)

    console.log
      [createProfileWithAccount] Profile creation result: {
        success: true,
        profileId: 'profile-123',
        error: undefined,
        errorCode: undefined
      }

      at log (src/lib/profile.ts:256:11)

    console.log
      [createProfileWithAccount] Step 2: Creating account via RPC: { accountName: "newuser's Account", ownerId: 'profile-123' }

      at log (src/lib/profile.ts:275:11)

    console.log
      [createProfileWithAccount] RPC success: { accountId: 'account-123' }

      at log (src/lib/profile.ts:307:11)

    console.log
      [getOrCreateProfile] Profile creation result: {
        created: true,
        profileId: 'profile-123',
        hasAccount: true,
        accountId: 'account-123',
        error: null
      }

      at log (src/lib/profile.ts:161:13)

    console.log
      [getOrCreateProfile] Starting lookup for authId: existing-auth-123

      at log (src/lib/profile.ts:45:13)

    console.log
      [getOrCreateProfile] Profile fetch result: {
        found: true,
        claimed: false,
        profileId: 'existing-profile-123',
        fetchError: undefined,
        errorCode: undefined
      }

      at log (src/lib/profile.ts:65:13)

    console.log
      [getOrCreateProfile] Existing profile found, fetching account...

      at log (src/lib/profile.ts:76:15)

    console.log
      [getOrCreateProfile] Account fetch result: {
        found: true,
        accountId: 'existing-account-123',
        accountName: 'Existing Account',
        fetchError: undefined
      }

      at log (src/lib/profile.ts:99:15)

    console.log
      [getOrCreateProfile] Starting lookup for authId: race-auth-123

      at log (src/lib/profile.ts:45:13)

    console.log
      [getOrCreateProfile] Profile fetch result: {
        found: false,
        claimed: false,
        profileId: undefined,
        fetchError: 'No rows found',
        errorCode: 'PGRST116'
      }

      at log (src/lib/profile.ts:65:13)

    console.log
      [getOrCreateProfile] No existing profile, creating new profile and account...

      at log (src/lib/profile.ts:153:13)

    console.log
      [createProfileWithAccount] Step 1: Creating user profile for: { authId: 'race-auth-123', email: 'race@example.com' }

      at log (src/lib/profile.ts:243:11)

    console.log
      [createProfileWithAccount] Profile creation result: {
        success: false,
        profileId: undefined,
        error: 'Duplicate key',
        errorCode: '23505'
      }

      at log (src/lib/profile.ts:256:11)

    console.error
      Profile creation error: {
        "code": "23505",
        "message": "Duplicate key"
      }

      262 |
      263 |   if (profileError) {
    > 264 |     console.error("Profile creation error:", JSON.stringify(profileError, null, 2));
          |             ^
      265 |     return {
      266 |       profile: null,
      267 |       account: null,

      at error (src/lib/profile.ts:264:13)
      at getOrCreateProfile (src/lib/profile.ts:155:41)
      at Object.<anonymous> (tests/rls/profile.test.ts:263:22)

    console.log
      [getOrCreateProfile] Profile creation result: {
        created: false,
        profileId: undefined,
        hasAccount: false,
        accountId: undefined,
        error: 'Failed to create profile. Please try again.'
      }

      at log (src/lib/profile.ts:161:13)

    console.log
      [getOrCreateProfile] Starting lookup for authId: auth-id

      at log (src/lib/profile.ts:45:13)

    console.log
      [getOrCreateProfile] Profile fetch result: {
        found: false,
        claimed: false,
        profileId: undefined,
        fetchError: 'Permission denied',
        errorCode: '42501'
      }

      at log (src/lib/profile.ts:65:13)

    console.error
      Profile fetch error: {
        "code": "42501",
        "message": "Permission denied"
      }

      140 |     // If no profile and error is not "no rows found", it's a real error
      141 |     if (fetchError && fetchError.code !== "PGRST116") {
    > 142 |       console.error("Profile fetch error:", JSON.stringify(fetchError, null, 2));
          |               ^
      143 |       return {
      144 |         profile: null,
      145 |         account: null,

      at error (src/lib/profile.ts:142:15)
      at Object.<anonymous> (tests/rls/profile.test.ts:335:22)

    console.error
      Profile update error: { code: '42501', message: 'Permission denied' }

      408 |
      409 |     if (error) {
    > 410 |       console.error("Profile update error:", error);
          |               ^
      411 |       return {
      412 |         profile: null,
      413 |         error: "Failed to update profile. Please try again.",

      at error (src/lib/profile.ts:410:15)
      at Object.<anonymous> (tests/rls/profile.test.ts:356:22)

PASS tests/llama/llama.test.ts
  ΓùÅ Console

    console.warn
      OPENROUTER_API_KEY not configured, using mock response

      223 |   if (!isOpenRouterConfigured()) {
      224 |     if (process.env.NODE_ENV === "development" || process.env.NODE_ENV === "test") {
    > 225 |       console.warn("OPENROUTER_API_KEY not configured, using mock response");
          |               ^
      226 |       return {
      227 |         suggestion: getMockResponse(selectionText, "suggestion"),
      228 |         rationale: "This is a mock suggestion for development",

      at warn (src/lib/llama.ts:225:15)
      at callLlamaAPI (src/lib/llama.ts:458:28)
      at Object.<anonymous> (tests/llama/llama.test.ts:132:23)

    console.warn
      OPENROUTER_API_KEY not configured, using mock response

      223 |   if (!isOpenRouterConfigured()) {
      224 |     if (process.env.NODE_ENV === "development" || process.env.NODE_ENV === "test") {
    > 225 |       console.warn("OPENROUTER_API_KEY not configured, using mock response");
          |               ^
      226 |       return {
      227 |         suggestion: getMockResponse(selectionText, "suggestion"),
      228 |         rationale: "This is a mock suggestion for development",

      at warn (src/lib/llama.ts:225:15)
      at callLlamaAPI (src/lib/llama.ts:458:28)
      at Object.<anonymous> (tests/llama/llama.test.ts:203:7)

PASS tests/rls/account.test.ts
  ΓùÅ Console

    console.error
      Account creation RPC error: { message: 'RPC Error' }

      43 |
      44 |     if (rpcError) {
    > 45 |       console.error("Account creation RPC error:", rpcError);
         |               ^
      46 |       return {
      47 |         account: null,
      48 |         error: "Failed to create account. Please try again.",

      at error (src/lib/account.ts:45:15)
      at Object.<anonymous> (tests/rls/account.test.ts:204:22)

PASS tests/manuscripts/MagicIngest.test.tsx
PASS tests/LoginForm.test.tsx
  ΓùÅ Console

    console.log
      {"level":"audit","type":"login_success","email":"test@example.com","timestamp":"2026-01-08T00:24:57.569Z"}

      at log (src/lib/audit.ts:54:11)

PASS tests/dashboard.test.tsx
PASS tests/manuscripts/ConsistencyReportViewer.test.tsx
PASS tests/components/support/CreateTicketForm.test.tsx
PASS tests/manuscripts/export.test.ts
PASS tests/lib/usage-admin.test.ts

Summary of all failing tests
FAIL tests/api/upload.test.ts
  ΓùÅ POST /api/manuscripts/upload ΓÇ║ should handle PDF file upload

    expect(received).toBe(expected) // Object.is equality

    Expected: "PDF Content"
    Received: "PDF import temporarily disabled due to build issues."

      108 |     expect(res.status).toBe(200);
      109 |     const data = await res.json();
    > 110 |     expect(data.chapters[0].content).toBe("PDF Content");
          |                                      ^
      111 |   });
      112 |
      113 |   it("should handle Markdown file upload", async () => {

      at Object.toBe (tests/api/upload.test.ts:110:38)

FAIL tests/manuscripts/consistency.test.ts
  ΓùÅ Consistency Checks ΓÇ║ initiateConsistencyCheck ΓÇ║ should start a check and return job ID

    supabaseUrl is required.

      541 |   const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
      542 |   const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;
    > 543 |   const backgroundClient = createClient(supabaseUrl, supabaseServiceKey);
          |                                        ^
      544 |
      545 |   const backgroundTask = async () => {
      546 |     try {

      at validateSupabaseUrl (node_modules/@supabase/supabase-js/src/lib/helpers.ts:86:11)
      at new SupabaseClient (node_modules/@supabase/supabase-js/src/SupabaseClient.ts:117:21)
      at createClient (node_modules/@supabase/supabase-js/src/index.ts:60:10)
      at initiateConsistencyCheck (src/lib/gemini.ts:543:40)
      at Object.<anonymous> (tests/manuscripts/consistency.test.ts:191:22)

FAIL tests/api/consistency-check.test.ts
  ΓùÅ POST /api/manuscripts/:id/consistency-check ΓÇ║ should create async job immediately and return job ID (AC 3.1.1)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      {"auth": {"getUser": [Function mockConstructor]}, "from": [Function mockConstructor]},
      Object {
        "manuscriptId": "ms-id",
    -   "userId": "user-id",
    +   "userId": "ms-id",
      },
    + [Function anonymous],

    Number of calls: 1

      135 |     expect(data.status).toBe("queued");
      136 |     expect(data.estimatedTokens).toBe(50000);
    > 137 |     expect(initiateConsistencyCheck).toHaveBeenCalledWith(
          |                                      ^
      138 |       mockSupabaseClient,
      139 |       {
      140 |         manuscriptId: "ms-id",

      at Object.toHaveBeenCalledWith (tests/api/consistency-check.test.ts:137:38)

  ΓùÅ POST /api/manuscripts/:id/consistency-check ΓÇ║ should return cached result immediately if available

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      160 |
      161 |     expect(response.status).toBe(202);
    > 162 |     expect(data.cached).toBe(true);
          |                         ^
      163 |     expect(data.status).toBe("completed");
      164 |   });
      165 |

      at Object.toBe (tests/api/consistency-check.test.ts:162:25)

FAIL tests/integration/usage-guardrails.test.ts
  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should start in good_standing

    Failed to create test account

      67 |     // 2. Create Test Account
      68 |     const { account, error } = await createAccount(adminSupabase, "Guardrails Test Account", testUserId);
    > 69 |     if (error || !account) throw new Error("Failed to create test account");
         |                                  ^
      70 |     testAccountId = account.id;
      71 |   });
      72 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:69:34)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should flag account after first month of overage

    Failed to create test account

      67 |     // 2. Create Test Account
      68 |     const { account, error } = await createAccount(adminSupabase, "Guardrails Test Account", testUserId);
    > 69 |     if (error || !account) throw new Error("Failed to create test account");
         |                                  ^
      70 |     testAccountId = account.id;
      71 |   });
      72 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:69:34)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should trigger upsell_required after second consecutive month of overage

    Failed to create test account

      67 |     // 2. Create Test Account
      68 |     const { account, error } = await createAccount(adminSupabase, "Guardrails Test Account", testUserId);
    > 69 |     if (error || !account) throw new Error("Failed to create test account");
         |                                  ^
      70 |     testAccountId = account.id;
      71 |   });
      72 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:69:34)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should block usage when status is upsell_required

    Failed to create test account

      67 |     // 2. Create Test Account
      68 |     const { account, error } = await createAccount(adminSupabase, "Guardrails Test Account", testUserId);
    > 69 |     if (error || !account) throw new Error("Failed to create test account");
         |                                  ^
      70 |     testAccountId = account.id;
      71 |   });
      72 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:69:34)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should reset to good_standing if usage drops in third month

    Failed to create test account

      67 |     // 2. Create Test Account
      68 |     const { account, error } = await createAccount(adminSupabase, "Guardrails Test Account", testUserId);
    > 69 |     if (error || !account) throw new Error("Failed to create test account");
         |                                  ^
      70 |     testAccountId = account.id;
      71 |   });
      72 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:69:34)


Test Suites: 4 failed, 24 passed, 28 total
Tests:       9 failed, 3 skipped, 182 passed, 194 total
Snapshots:   0 total
Time:        5.896 s
Ran all test suites.
