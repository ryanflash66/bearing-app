
> bearing-app@1.0.0 test
> jest tests/rls/account.test.ts tests/rls/profile.test.ts tests/lib/ai-usage.test.ts

PASS tests/rls/profile.test.ts
  ΓùÅ Console

    console.log
      [getOrCreateProfile] Starting lookup for authId: auth-user-123

      at log (src/lib/profile.ts:45:13)

    console.log
      [getOrCreateProfile] Profile fetch result: {
        found: false,
        claimed: false,
        profileId: undefined,
        fetchError: 'No rows found',
        errorCode: 'PGRST116'
      }

      at log (src/lib/profile.ts:65:13)

    console.log
      [getOrCreateProfile] No existing profile, creating new profile and account...

      at log (src/lib/profile.ts:153:13)

    console.log
      [createProfileWithAccount] Step 1: Creating user profile for: { authId: 'auth-user-123', email: 'newuser@example.com' }

      at log (src/lib/profile.ts:243:11)

    console.log
      [createProfileWithAccount] Profile creation result: {
        success: true,
        profileId: 'profile-123',
        error: undefined,
        errorCode: undefined
      }

      at log (src/lib/profile.ts:256:11)

    console.log
      [createProfileWithAccount] Step 2: Creating account via RPC: { accountName: "newuser's Account", ownerId: 'profile-123' }

      at log (src/lib/profile.ts:275:11)

    console.log
      [createProfileWithAccount] RPC success: { accountId: 'account-123' }

      at log (src/lib/profile.ts:307:11)

    console.log
      [getOrCreateProfile] Profile creation result: {
        created: true,
        profileId: 'profile-123',
        hasAccount: true,
        accountId: 'account-123',
        error: null
      }

      at log (src/lib/profile.ts:161:13)

    console.log
      [getOrCreateProfile] Starting lookup for authId: existing-auth-123

      at log (src/lib/profile.ts:45:13)

    console.log
      [getOrCreateProfile] Profile fetch result: {
        found: true,
        claimed: false,
        profileId: 'existing-profile-123',
        fetchError: undefined,
        errorCode: undefined
      }

      at log (src/lib/profile.ts:65:13)

    console.log
      [getOrCreateProfile] Existing profile found, fetching account...

      at log (src/lib/profile.ts:76:15)

    console.log
      [getOrCreateProfile] Account fetch result: {
        found: true,
        accountId: 'existing-account-123',
        accountName: 'Existing Account',
        fetchError: undefined
      }

      at log (src/lib/profile.ts:99:15)

    console.log
      [getOrCreateProfile] Starting lookup for authId: race-auth-123

      at log (src/lib/profile.ts:45:13)

    console.log
      [getOrCreateProfile] Profile fetch result: {
        found: false,
        claimed: false,
        profileId: undefined,
        fetchError: 'No rows found',
        errorCode: 'PGRST116'
      }

      at log (src/lib/profile.ts:65:13)

    console.log
      [getOrCreateProfile] No existing profile, creating new profile and account...

      at log (src/lib/profile.ts:153:13)

    console.log
      [createProfileWithAccount] Step 1: Creating user profile for: { authId: 'race-auth-123', email: 'race@example.com' }

      at log (src/lib/profile.ts:243:11)

    console.log
      [createProfileWithAccount] Profile creation result: {
        success: false,
        profileId: undefined,
        error: 'Duplicate key',
        errorCode: '23505'
      }

      at log (src/lib/profile.ts:256:11)

    console.error
      Profile creation error: {
        "code": "23505",
        "message": "Duplicate key"
      }

      262 |
      263 |   if (profileError) {
    > 264 |     console.error("Profile creation error:", JSON.stringify(profileError, null, 2));
          |             ^
      265 |     return {
      266 |       profile: null,
      267 |       account: null,

      at error (src/lib/profile.ts:264:13)
      at getOrCreateProfile (src/lib/profile.ts:155:41)
      at Object.<anonymous> (tests/rls/profile.test.ts:263:22)

    console.log
      [getOrCreateProfile] Profile creation result: {
        created: false,
        profileId: undefined,
        hasAccount: false,
        accountId: undefined,
        error: 'Failed to create profile. Please try again.'
      }

      at log (src/lib/profile.ts:161:13)

    console.log
      [getOrCreateProfile] Starting lookup for authId: auth-id

      at log (src/lib/profile.ts:45:13)

    console.log
      [getOrCreateProfile] Profile fetch result: {
        found: false,
        claimed: false,
        profileId: undefined,
        fetchError: 'Permission denied',
        errorCode: '42501'
      }

      at log (src/lib/profile.ts:65:13)

    console.error
      Profile fetch error: {
        "code": "42501",
        "message": "Permission denied"
      }

      140 |     // If no profile and error is not "no rows found", it's a real error
      141 |     if (fetchError && fetchError.code !== "PGRST116") {
    > 142 |       console.error("Profile fetch error:", JSON.stringify(fetchError, null, 2));
          |               ^
      143 |       return {
      144 |         profile: null,
      145 |         account: null,

      at error (src/lib/profile.ts:142:15)
      at Object.<anonymous> (tests/rls/profile.test.ts:335:22)

    console.error
      Profile update error: { code: '42501', message: 'Permission denied' }

      408 |
      409 |     if (error) {
    > 410 |       console.error("Profile update error:", error);
          |               ^
      411 |       return {
      412 |         profile: null,
      413 |         error: "Failed to update profile. Please try again.",

      at error (src/lib/profile.ts:410:15)
      at Object.<anonymous> (tests/rls/profile.test.ts:356:22)

PASS tests/rls/account.test.ts
  ΓùÅ Console

    console.error
      Account creation RPC error: { message: 'RPC Error' }

      43 |
      44 |     if (rpcError) {
    > 45 |       console.error("Account creation RPC error:", rpcError);
         |               ^
      46 |       return {
      47 |         account: null,
      48 |         error: "Failed to create account. Please try again.",

      at error (src/lib/account.ts:45:15)
      at Object.<anonymous> (tests/rls/account.test.ts:204:22)

FAIL tests/lib/ai-usage.test.ts
  ΓùÅ Test suite failed to run

      x await isn't allowed in non-async function
        ,-[R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\lib\ai-usage.test.ts:82:1]
     79 |       await expect(checkUsageLimit(mockSupabase, accountId, 1000)).resolves.not.toThrow();
     80 |     });
     81 | 
     82 |       await expect(checkUsageLimit(mockSupabase, accountId, 1000)).resolves.not.toThrow();
        :       ^^^^^
     83 |     });
     84 | 
     84 |     it("throws when usage exceeds cap", async () => {
        `----
      x await isn't allowed in non-async function
         ,-[R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\lib\ai-usage.test.ts:127:1]
     124 |       await expect(checkUsageLimit(mockSupabase, accountId, 200)).rejects.toThrow(/Monthly AI token limit reached/);
     125 |     });
     126 | 
     127 |       await expect(checkUsageLimit(mockSupabase, accountId, 200)).rejects.toThrow(/Monthly AI token limit reached/);
         :       ^^^^^
     128 |     });
     129 |   });
     129 | 
         `----
      x Expression expected
         ,-[R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\lib\ai-usage.test.ts:129:1]
     126 | 
     127 |       await expect(checkUsageLimit(mockSupabase, accountId, 200)).rejects.toThrow(/Monthly AI token limit reached/);
     128 |     });
     129 |   });
         :   ^
     130 | 
     131 |   describe("logUsageEvent", () => {
     131 |     it("inserts event into db", async () => {
         `----


    Caused by:
        Syntax Error

      at Object.transformSync (node_modules/next/src/build/swc/index.ts:1460:25)
      at transformSync (node_modules/next/src/build/swc/index.ts:1591:19)
      at Object.process (node_modules/next/src/build/swc/jest-transformer.ts:105:25)
      at ScriptTransformer.transformSource (node_modules/@jest/transform/build/index.js:422:31)
      at ScriptTransformer._transformAndBuildScript (node_modules/@jest/transform/build/index.js:519:40)
      at ScriptTransformer.transform (node_modules/@jest/transform/build/index.js:558:19)

Test Suites: 1 failed, 2 passed, 3 total
Tests:       23 passed, 23 total
Snapshots:   0 total
Time:        1.521 s
Ran all test suites matching tests/rls/account.test.ts|tests/rls/profile.test.ts|tests/lib/ai-usage.test.ts.
