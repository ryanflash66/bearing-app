
> bearing-app@1.0.0 test
> jest tests/rls/profile.test.ts tests/lib/ai-usage.test.ts tests/integration/usage-guardrails.test.ts tests/api/upload.test.ts tests/manuscripts/consistency.test.ts tests/api/consistency-check.test.ts

FAIL tests/integration/usage-guardrails.test.ts
  ΓùÅ Console

    console.log
      [dotenv@17.2.3] injecting env (3) from .env.local -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

    console.error
      TypeError: fetch failed
          at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\integration\usage-guardrails.test.ts:53:46) {
        [cause]: Error: getaddrinfo ENOTFOUND mock.supabase.co
            at ignore-listed frames {
          errno: -3008,
          code: 'ENOTFOUND',
          syscall: 'getaddrinfo',
          hostname: 'mock.supabase.co'
        }
      }

      51 |     // Given the constraints, let's focus on the *logic* of the PL/pgSQL function.
      52 |     
    > 53 |     const { data: user, error: userError } = await adminSupabase.auth.admin.createUser({
         |                                              ^
      54 |       email: `test_guardrails_${Date.now()}@example.com`,
      55 |       password: "password123",
      56 |       email_confirm: true

      at _handleRequest (node_modules/@supabase/auth-js/src/lib/fetch.ts:188:13)
      at _request (node_modules/@supabase/auth-js/src/lib/fetch.ts:157:16)
      at GoTrueAdminApi.createUser (node_modules/@supabase/auth-js/src/GoTrueAdminApi.ts:194:14)
      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:53:46)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should start in good_standing

    Failed to create test user: fetch failed

      58 |     
      59 |     if (userError || !user.user) {
    > 60 |         throw new Error("Failed to create test user: " + userError?.message);
         |               ^
      61 |     }
      62 |     testUserId = user.user.id;
      63 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:60:15)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should flag account after first month of overage

    Failed to create test user: fetch failed

      58 |     
      59 |     if (userError || !user.user) {
    > 60 |         throw new Error("Failed to create test user: " + userError?.message);
         |               ^
      61 |     }
      62 |     testUserId = user.user.id;
      63 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:60:15)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should trigger upsell_required after second consecutive month of overage

    Failed to create test user: fetch failed

      58 |     
      59 |     if (userError || !user.user) {
    > 60 |         throw new Error("Failed to create test user: " + userError?.message);
         |               ^
      61 |     }
      62 |     testUserId = user.user.id;
      63 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:60:15)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should block usage when status is upsell_required

    Failed to create test user: fetch failed

      58 |     
      59 |     if (userError || !user.user) {
    > 60 |         throw new Error("Failed to create test user: " + userError?.message);
         |               ^
      61 |     }
      62 |     testUserId = user.user.id;
      63 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:60:15)

  ΓùÅ Usage Guardrails Integration (Story 4.1) ΓÇ║ should reset to good_standing if usage drops in third month

    Failed to create test user: fetch failed

      58 |     
      59 |     if (userError || !user.user) {
    > 60 |         throw new Error("Failed to create test user: " + userError?.message);
         |               ^
      61 |     }
      62 |     testUserId = user.user.id;
      63 |

      at Object.<anonymous> (tests/integration/usage-guardrails.test.ts:60:15)

PASS tests/manuscripts/consistency.test.ts
  ΓùÅ Console

    console.error
      Error calling OpenRouter API: ZodError: [
        {
          "code": "invalid_value",
          "values": [
            "character",
            "plot",
            "timeline",
            "tone"
          ],
          "path": [
            "issues",
            0,
            "type"
          ],
          "message": "Invalid option: expected one of \"character\"|\"plot\"|\"timeline\"|\"tone\""
        },
        {
          "code": "invalid_value",
          "values": [
            "low",
            "medium",
            "high"
          ],
          "path": [
            "issues",
            0,
            "severity"
          ],
          "message": "Invalid option: expected one of \"low\"|\"medium\"|\"high\""
        }
      ]
          at parse (R:\Dropbox\_Code\Projects\bearing\bearing-app\src\lib\gemini.ts:337:44)
          at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\manuscripts\consistency.test.ts:165:7)

      344 |       throw new Error(detailedError);
      345 |     }
    > 346 |     console.error("Error calling OpenRouter API:", error);
          |             ^
      347 |     throw error;
      348 |   }
      349 | }

      at error (src/lib/gemini.ts:346:13)
      at Object.<anonymous> (tests/manuscripts/consistency.test.ts:165:7)

    console.error
      Error updating job status to running: {
        message: 'TypeError: res$1.text is not a function',
        details: 'TypeError: res$1.text is not a function\n' +
          '    at R:\\Dropbox\\_Code\\Projects\\bearing\\bearing-app\\node_modules\\@supabase\\postgrest-js\\src\\PostgrestBuilder.ts:136:34\n' +
          '    at processConsistencyCheckJob (R:\\Dropbox\\_Code\\Projects\\bearing\\bearing-app\\src\\lib\\gemini.ts:365:36)\n' +
          '    at backgroundTask (R:\\Dropbox\\_Code\\Projects\\bearing\\bearing-app\\src\\lib\\gemini.ts:547:7)',
        hint: '',
        code: ''
      }

      369 |
      370 |     if (updateError) {
    > 371 |       console.error("Error updating job status to running:", updateError);
          |               ^
      372 |       return { success: false, error: updateError.message };
      373 |     }
      374 |

      at error (src/lib/gemini.ts:371:15)
      at backgroundTask (src/lib/gemini.ts:547:7)

    console.log
      Mock JSON called. Mock Report: {"issues":[],"summary":"No issues."}

      at Object.log (tests/manuscripts/consistency.test.ts:214:19)

PASS tests/api/consistency-check.test.ts
  ΓùÅ Console

    console.error
      Error initiating consistency check: Error: Token cap exceeded. You have 0 remaining this month.
          at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\api\consistency-check.test.ts:233:7)
          at Promise.finally.completed (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
          at _callCircusTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
          at runNextTicks (node:internal/process/task_queues:65:5)
          at processImmediate (node:internal/timers:453:9)
          at process.callbackTrampoline (node:internal/async_hooks:130:17)
          at _runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
          at R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
          at run (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
          at jestAdapter (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\runner.js:101:19)
          at runTestInternal (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\index.js:275:16)
          at runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\index.js:343:7)

      89 |     }, { status: 202 });
      90 |   } catch (error) {
    > 91 |     console.error("Error initiating consistency check:", error);
         |             ^
      92 |     
      93 |     // Handle token cap errors specifically
      94 |     if (error instanceof Error && error.message.includes("Token cap")) {

      at error (src/app/api/manuscripts/[id]/consistency-check/route.ts:91:13)
      at Object.<anonymous> (tests/api/consistency-check.test.ts:240:22)

    console.error
      Error initiating consistency check: Error: Manuscript content is empty
          at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\api\consistency-check.test.ts:249:7)
          at Promise.finally.completed (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
          at _callCircusTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
          at runNextTicks (node:internal/process/task_queues:65:5)
          at processImmediate (node:internal/timers:453:9)
          at process.callbackTrampoline (node:internal/async_hooks:130:17)
          at _runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
          at R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
          at run (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
          at jestAdapter (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\runner.js:101:19)
          at runTestInternal (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\index.js:275:16)
          at runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\index.js:343:7)

      89 |     }, { status: 202 });
      90 |   } catch (error) {
    > 91 |     console.error("Error initiating consistency check:", error);
         |             ^
      92 |     
      93 |     // Handle token cap errors specifically
      94 |     if (error instanceof Error && error.message.includes("Token cap")) {

      at error (src/app/api/manuscripts/[id]/consistency-check/route.ts:91:13)
      at Object.<anonymous> (tests/api/consistency-check.test.ts:256:22)

    console.error
      Error initiating consistency check: Error: Network error
          at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\api\consistency-check.test.ts:564:7)
          at Promise.finally.completed (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
          at _callCircusTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
          at runNextTicks (node:internal/process/task_queues:65:5)
          at processImmediate (node:internal/timers:453:9)
          at process.callbackTrampoline (node:internal/async_hooks:130:17)
          at _runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
          at R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
          at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
          at run (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
          at runAndTransformResultsToJestFormat (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
          at jestAdapter (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\runner.js:101:19)
          at runTestInternal (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\index.js:275:16)
          at runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\index.js:343:7)

      89 |     }, { status: 202 });
      90 |   } catch (error) {
    > 91 |     console.error("Error initiating consistency check:", error);
         |             ^
      92 |     
      93 |     // Handle token cap errors specifically
      94 |     if (error instanceof Error && error.message.includes("Token cap")) {

      at error (src/app/api/manuscripts/[id]/consistency-check/route.ts:91:13)
      at Object.<anonymous> (tests/api/consistency-check.test.ts:579:23)

PASS tests/api/upload.test.ts
PASS tests/rls/profile.test.ts
  ΓùÅ Console

    console.log
      [getOrCreateProfile] Starting lookup for authId: auth-user-123

      at log (src/lib/profile.ts:45:13)

    console.log
      [getOrCreateProfile] Profile fetch result: {
        found: false,
        claimed: false,
        profileId: undefined,
        fetchError: 'No rows found',
        errorCode: 'PGRST116'
      }

      at log (src/lib/profile.ts:65:13)

    console.log
      [getOrCreateProfile] No existing profile, creating new profile and account...

      at log (src/lib/profile.ts:153:13)

    console.log
      [createProfileWithAccount] Step 1: Creating user profile for: { authId: 'auth-user-123', email: 'newuser@example.com' }

      at log (src/lib/profile.ts:243:11)

    console.log
      [createProfileWithAccount] Profile creation result: {
        success: true,
        profileId: 'profile-123',
        error: undefined,
        errorCode: undefined
      }

      at log (src/lib/profile.ts:256:11)

    console.log
      [createProfileWithAccount] Step 2: Creating account via RPC: { accountName: "newuser's Account", ownerId: 'profile-123' }

      at log (src/lib/profile.ts:275:11)

    console.log
      [createProfileWithAccount] RPC success: { accountId: 'account-123' }

      at log (src/lib/profile.ts:307:11)

    console.log
      [getOrCreateProfile] Profile creation result: {
        created: true,
        profileId: 'profile-123',
        hasAccount: true,
        accountId: 'account-123',
        error: null
      }

      at log (src/lib/profile.ts:161:13)

    console.log
      [getOrCreateProfile] Starting lookup for authId: existing-auth-123

      at log (src/lib/profile.ts:45:13)

    console.log
      [getOrCreateProfile] Profile fetch result: {
        found: true,
        claimed: false,
        profileId: 'existing-profile-123',
        fetchError: undefined,
        errorCode: undefined
      }

      at log (src/lib/profile.ts:65:13)

    console.log
      [getOrCreateProfile] Existing profile found, fetching account...

      at log (src/lib/profile.ts:76:15)

    console.log
      [getOrCreateProfile] Account fetch result: {
        found: true,
        accountId: 'existing-account-123',
        accountName: 'Existing Account',
        fetchError: undefined
      }

      at log (src/lib/profile.ts:99:15)

    console.log
      [getOrCreateProfile] Starting lookup for authId: race-auth-123

      at log (src/lib/profile.ts:45:13)

    console.log
      [getOrCreateProfile] Profile fetch result: {
        found: false,
        claimed: false,
        profileId: undefined,
        fetchError: 'No rows found',
        errorCode: 'PGRST116'
      }

      at log (src/lib/profile.ts:65:13)

    console.log
      [getOrCreateProfile] No existing profile, creating new profile and account...

      at log (src/lib/profile.ts:153:13)

    console.log
      [createProfileWithAccount] Step 1: Creating user profile for: { authId: 'race-auth-123', email: 'race@example.com' }

      at log (src/lib/profile.ts:243:11)

    console.log
      [createProfileWithAccount] Profile creation result: {
        success: false,
        profileId: undefined,
        error: 'Duplicate key',
        errorCode: '23505'
      }

      at log (src/lib/profile.ts:256:11)

    console.error
      Profile creation error: {
        "code": "23505",
        "message": "Duplicate key"
      }

      262 |
      263 |   if (profileError) {
    > 264 |     console.error("Profile creation error:", JSON.stringify(profileError, null, 2));
          |             ^
      265 |     return {
      266 |       profile: null,
      267 |       account: null,

      at error (src/lib/profile.ts:264:13)
      at getOrCreateProfile (src/lib/profile.ts:155:41)
      at Object.<anonymous> (tests/rls/profile.test.ts:263:22)

    console.log
      [getOrCreateProfile] Profile creation result: {
        created: false,
        profileId: undefined,
        hasAccount: false,
        accountId: undefined,
        error: 'Failed to create profile. Please try again.'
      }

      at log (src/lib/profile.ts:161:13)

    console.log
      [getOrCreateProfile] Starting lookup for authId: auth-id

      at log (src/lib/profile.ts:45:13)

    console.log
      [getOrCreateProfile] Profile fetch result: {
        found: false,
        claimed: false,
        profileId: undefined,
        fetchError: 'Permission denied',
        errorCode: '42501'
      }

      at log (src/lib/profile.ts:65:13)

    console.error
      Profile fetch error: {
        "code": "42501",
        "message": "Permission denied"
      }

      140 |     // If no profile and error is not "no rows found", it's a real error
      141 |     if (fetchError && fetchError.code !== "PGRST116") {
    > 142 |       console.error("Profile fetch error:", JSON.stringify(fetchError, null, 2));
          |               ^
      143 |       return {
      144 |         profile: null,
      145 |         account: null,

      at error (src/lib/profile.ts:142:15)
      at Object.<anonymous> (tests/rls/profile.test.ts:335:22)

    console.error
      Profile update error: { code: '42501', message: 'Permission denied' }

      408 |
      409 |     if (error) {
    > 410 |       console.error("Profile update error:", error);
          |               ^
      411 |       return {
      412 |         profile: null,
      413 |         error: "Failed to update profile. Please try again.",

      at error (src/lib/profile.ts:410:15)
      at Object.<anonymous> (tests/rls/profile.test.ts:356:22)

PASS tests/lib/ai-usage.test.ts

Test Suites: 1 failed, 5 passed, 6 total
Tests:       5 failed, 1 skipped, 32 passed, 38 total
Snapshots:   0 total
Time:        2.227 s
Ran all test suites matching tests/rls/profile.test.ts|tests/lib/ai-usage.test.ts|tests/integration/usage-guardrails.test.ts|tests/api/upload.test.ts|tests/manuscripts/consistency.test.ts|tests/api/consistency-check.test.ts.
