
> bearing-app@1.0.0 test
> jest tests/api/consistency-check.test.ts

  console.error
    Error initiating consistency check: Error: Token cap exceeded. You have 0 remaining this month.
        at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\api\consistency-check.test.ts:215:7)
        at Promise.finally.completed (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at _runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\index.js:275:16)
        at runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\index.js:343:7)

    [0m [90m 89 |[39m     }[33m,[39m { status[33m:[39m [35m202[39m })[33m;[39m
     [90m 90 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 91 |[39m     console[33m.[39merror([32m"Error initiating consistency check:"[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 92 |[39m     
     [90m 93 |[39m     [90m// Handle token cap errors specifically[39m
     [90m 94 |[39m     [36mif[39m (error [36minstanceof[39m [33mError[39m [33m&&[39m error[33m.[39mmessage[33m.[39mincludes([32m"Token cap"[39m)) {[0m

      at error (src/app/api/manuscripts/[id]/consistency-check/route.ts:91:13)
      at Object.<anonymous> (tests/api/consistency-check.test.ts:222:22)

  console.error
    Error initiating consistency check: Error: Manuscript content is empty
        at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\api\consistency-check.test.ts:231:7)
        at Promise.finally.completed (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at _runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\index.js:275:16)
        at runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\index.js:343:7)

    [0m [90m 89 |[39m     }[33m,[39m { status[33m:[39m [35m202[39m })[33m;[39m
     [90m 90 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 91 |[39m     console[33m.[39merror([32m"Error initiating consistency check:"[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 92 |[39m     
     [90m 93 |[39m     [90m// Handle token cap errors specifically[39m
     [90m 94 |[39m     [36mif[39m (error [36minstanceof[39m [33mError[39m [33m&&[39m error[33m.[39mmessage[33m.[39mincludes([32m"Token cap"[39m)) {[0m

      at error (src/app/api/manuscripts/[id]/consistency-check/route.ts:91:13)
      at Object.<anonymous> (tests/api/consistency-check.test.ts:238:22)

  console.error
    Error initiating consistency check: Error: Network error
        at Object.<anonymous> (R:\Dropbox\_Code\Projects\bearing\bearing-app\tests\api\consistency-check.test.ts:546:7)
        at Promise.finally.completed (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at _runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\index.js:275:16)
        at runTest (R:\Dropbox\_Code\Projects\bearing\bearing-app\node_modules\jest-runner\build\index.js:343:7)

    [0m [90m 89 |[39m     }[33m,[39m { status[33m:[39m [35m202[39m })[33m;[39m
     [90m 90 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 91 |[39m     console[33m.[39merror([32m"Error initiating consistency check:"[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 92 |[39m     
     [90m 93 |[39m     [90m// Handle token cap errors specifically[39m
     [90m 94 |[39m     [36mif[39m (error [36minstanceof[39m [33mError[39m [33m&&[39m error[33m.[39mmessage[33m.[39mincludes([32m"Token cap"[39m)) {[0m

      at error (src/app/api/manuscripts/[id]/consistency-check/route.ts:91:13)
      at Object.<anonymous> (tests/api/consistency-check.test.ts:561:23)

FAIL tests/api/consistency-check.test.ts
  POST /api/manuscripts/:id/consistency-check
    â”œÃ¹ should create async job immediately and return job ID (AC 3.1.1) (7 ms)
    â”œÃ¹ should return cached result immediately if available (1 ms)
    Î“ÃªÃœ should return 401 for unauthenticated requests (1 ms)
    â”œÃ¹ should return 404 for non-existent manuscript
    Î“ÃªÃœ should return 429 for token cap exceeded (23 ms)
    Î“ÃªÃœ should return 400 for empty manuscript content (3 ms)
  GET /api/manuscripts/:id/consistency-check
    Î“ÃªÃœ should return latest consistency check job (1 ms)
    Î“ÃªÃœ should return specific job when jobId provided (1 ms)
    Î“ÃªÃœ should return null when no job found (1 ms)
  Large manuscript chunking (AC 3.1.3)
    Î“ÃªÃœ should chunk large manuscripts into safe segments (2 ms)
    Î“ÃªÃœ should return single chunk for small manuscripts (1 ms)
  Retry scenarios (AC 3.1.5)
    Î“ÃªÃœ should mark job as failed on API error (1 ms)
    Î“ÃªÃœ should allow retry after failure (4 ms)

  Î“Ã¹Ã… POST /api/manuscripts/:id/consistency-check Î“Ã‡â•‘ should create async job immediately and return job ID (AC 3.1.1)

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      {"auth": {"getUser": [Function mockConstructor]}, "from": [Function mockConstructor]},
      {"manuscriptId": "ms-id", "userId": "user-id"},
    + [Function anonymous],

    Number of calls: 1

      154 |     expect(data.status).toBe("queued");
      155 |     expect(data.estimatedTokens).toBe(50000);
    > 156 |     expect(initiateConsistencyCheck).toHaveBeenCalledWith(
          |                                      ^
      157 |       mockSupabaseClient,
      158 |       {
      159 |         manuscriptId: "ms-id",

      at Object.toHaveBeenCalledWith (tests/api/consistency-check.test.ts:156:38)

  Î“Ã¹Ã… POST /api/manuscripts/:id/consistency-check Î“Ã‡â•‘ should return cached result immediately if available

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      179 |
      180 |     expect(response.status).toBe(202);
    > 181 |     expect(data.cached).toBe(true);
          |                         ^
      182 |     expect(data.status).toBe("completed");
      183 |   });
      184 |

      at Object.toBe (tests/api/consistency-check.test.ts:181:25)

  Î“Ã¹Ã… POST /api/manuscripts/:id/consistency-check Î“Ã‡â•‘ should return 404 for non-existent manuscript

    TypeError: mockSupabaseClient.from(...).select(...).eq(...).is is not a function

      198 |
      199 |   it("should return 404 for non-existent manuscript", async () => {
    > 200 |     mockSupabaseClient.from().select().eq().is().single.mockResolvedValue({
          |                                             ^
      201 |       data: null,
      202 |       error: { message: "Not found" },
      203 |     });

      at Object.is (tests/api/consistency-check.test.ts:200:45)

Test Suites: 1 failed, 1 total
Tests:       3 failed, 10 passed, 13 total
Snapshots:   0 total
Time:        1.415 s
Ran all test suites matching tests/api/consistency-check.test.ts.
